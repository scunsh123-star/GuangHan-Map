<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ™ºèµ‹èƒ½ä¹¡æ‘ Â· å¹¿æ±‰è°ƒç ”æˆæœ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Leaflet MiniMap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.css" />
    <!-- Leaflet Measure CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #222;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            display: block; /* å¼ºåˆ¶å—çº§æ˜¾ç¤º */
        }

        /* --- UIç»„ä»¶ï¼šèµ›åšæœ‹å…‹é£æ ¼æ ‡é¢˜ --- */
        .custom-title {
            position: absolute;
            top: 20px;
            left: 60px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 15px 25px;
            border-radius: 4px;
            border-left: 5px solid #00eaeb;
            color: white;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 234, 235, 0.3);
            pointer-events: none;
        }

        .custom-title h2 {
            margin: 0 0 5px 0;
            font-size: 24px;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 0 10px #00eaeb;
        }

        .custom-title .subtitle {
            font-size: 14px;
            color: #cccccc;
            display: block;
            margin-bottom: 8px;
        }

        .custom-title .tag {
            font-size: 11px;
            color: #000;
            background-color: #00eaeb;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 2px;
            margin-right: 5px;
        }

        /* --- UIç»„ä»¶ï¼šä¹¡é•‡å¿«é€Ÿå¯¼èˆªä¸­æ§å° --- */
        .town-navigator {
            position: absolute;
            top: 140px; /* ä½äºå›¾å±‚æ§åˆ¶ä¸‹æ–¹ */
            left: 60px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 4px;
            border-right: 4px solid #FF1493; /* ç²‰è‰²å¼ºè°ƒè‰² */
            color: white;
            width: 200px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(255, 20, 147, 0.2);
        }

        .town-navigator h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #FF1493;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .town-select {
            width: 100%;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            font-size: 13px;
        }
        
        .town-select:hover {
            border-color: #FF1493;
        }

        /* --- å¼¹çª—æ ·å¼ä¼˜åŒ– --- */
        .leaflet-popup-content-wrapper {
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            border: 1px solid #00eaeb;
            border-radius: 2px;
        }
        .leaflet-popup-tip {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .popup-table {
            width: 100%;
            margin-top: 8px;
            font-size: 12px;
            border-collapse: collapse;
        }
        .popup-table td {
            padding: 3px 5px;
            border-bottom: 1px solid #333;
        }
        .popup-data {
            color: #00eaeb;
            font-weight: bold;
            text-align: right;
        }
        .popup-trend-up { color: #32CD32; }
        .popup-trend-down { color: #FF4500; }

        /* ä¿®å¤æ§ä»¶æ ·å¼ */
        .leaflet-control-layers, .leaflet-control-measure {
            background: rgba(0, 0, 0, 0.85) !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        .leaflet-control-measure .tasks { color: #fff !important; }
    </style>
</head>
<body>

    <!-- æµ®åŠ¨æ ‡é¢˜ UI -->
    <div class="custom-title">
        <h2>æ•°æ™ºèµ‹èƒ½ä¹¡æ‘ Â· å¹¿æ±‰è°ƒç ”æˆæœ</h2>
        <span class="subtitle">æ¸…åå¤§å­¦ä¹¡æ‘æŒ¯å…´å·¥ä½œç«™(å¹¿æ±‰æ”¯é˜Ÿ)</span>
        <span class="tag">SPATIAL ANALYSIS</span>
        <span class="tag" style="background-color: #FF1493; color: white;">V 2.5 (Stable)</span>
    </div>

    <!-- ä¹¡é•‡å¿«é€Ÿå¯¼èˆªä¸­æ§å° -->
    <div class="town-navigator">
        <h4><i class="fa-solid fa-location-crosshairs"></i> åŒºåŸŸå¿«é€Ÿå®šä½</h4>
        <select id="townSelect" class="town-select" onchange="flyToTown(this.value)">
            <option value="" disabled selected>-- é€‰æ‹©ä¹¡é•‡/åŒºåŸŸ --</option>
            <!-- é€‰é¡¹å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
        </select>
    </div>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map"></div>

    <!-- æ ¸å¿ƒåº“ JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <!-- ä½¿ç”¨ unpkg æºåŠ è½½ ant-path -->
    <script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.js"></script>
    <!-- æ›´æ¢ä¸º unpkg æºåŠ è½½ leaflet-measure -->
    <script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>

    <script>
        // --- 1. åˆå§‹åŒ–åœ°å›¾ ---
        const map = L.map('map', {
            center: [30.98, 104.25],
            zoom: 12, // ç¨å¾®æ‹‰è¿‘ä¸€ç‚¹
            zoomControl: false 
        });

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // --- 2. æ•°æ®å®šä¹‰ï¼šå…³é”®èŠ‚ç‚¹ä¸ä¹¡é•‡ä¸­å¿ƒ ---
        
        // ä¹¡é•‡/åŒºåŸŸå¯¼èˆªæ•°æ® (ä¸­å¿ƒç‚¹)
        const towns = [
            { name: "çåŸè¡—é“ (å¸‚ä¸­å¿ƒ)", coords: [30.976, 104.251] },
            { name: "ä¸‰æ°´é•‡ (ç”Ÿæ€)", coords: [30.950, 104.220] },
            { name: "é«˜åªé•‡ (äº§ä¸š)", coords: [30.990, 104.280] },
            { name: "è¿å±±é•‡ (æ–‡æ—…)", coords: [31.020, 104.300] },
            { name: "ä¸‰æ˜Ÿå †é•‡ (é—å€)", coords: [30.993, 104.205] },
            { name: "å‘é˜³é•‡ (æ”¹é©)", coords: [31.050, 104.240] },
            { name: "é‡‘é±¼é•‡ (èŠ±æœ¨)", coords: [30.940, 104.280] },
            { name: "å—å…´é•‡ (é€šèˆª)", coords: [30.980, 104.200] },
            { name: "å°æ±‰é•‡ (å†œè€•)", coords: [31.010, 104.260] },
            { name: "æ¾æ—é•‡ (æ°´æœ)", coords: [31.040, 104.320] },
            { name: "é‡‘è½®é•‡ (å¤§è’œ)", coords: [31.030, 104.180] }
        ];

        // è¯¦ç»† POI èŠ‚ç‚¹æ•°æ® (18ä¸ª)
        const poiData = [
            // --- ç”Ÿæ€ä¸å†œä¸šç»„ (Green) ---
            { name: "æ˜“å®¶æ²³å", coords: [30.95, 104.22], group: "eco", icon: "leaf", desc: "å›½å®¶çº§æ°´åˆ©é£æ™¯åŒºï¼Œæ²³æµç”Ÿæ€ä¿®å¤ç¤ºèŒƒç‚¹ã€‚", stats: { "æ°´è´¨ç­‰çº§": "IIç±»", "æ—¥å‡æ¸¸å®¢": "2000+" } },
            { name: "å‹è°Šæ‘å…šç¾¤ä¸­å¿ƒ", coords: [30.958, 104.235], group: "eco", icon: "building-user", desc: "æ•°å­—åŒ–ä¹¡æ‘æ²»ç†è¯•ç‚¹ï¼ŒåŸºå±‚å…šå»ºé˜µåœ°ã€‚", stats: { "æœåŠ¡æ‘æ°‘": "3500äºº", "åŠäº‹æ•ˆç‡": "+40%" } },
            { name: "é‡‘é±¼é•‡èŠ±æœ¨åŸºåœ°", coords: [30.945, 104.285], group: "eco", icon: "tree", desc: "è¥¿éƒ¨è‘—åçš„èŠ±å‰è‹—æœ¨ç§æ¤åŸºåœ°ã€‚", stats: { "ç§æ¤é¢ç§¯": "1.2ä¸‡äº©", "å¹´äº§å€¼": "3äº¿å…ƒ" } },
            { name: "é‡‘è½®å¤§è’œäº§ä¸šå›­", coords: [31.035, 104.185], group: "eco", icon: "seedling", desc: "ç‰¹äº§'é‡‘è½®å¤§è’œ'æ ¸å¿ƒäº§åŒºã€‚", stats: { "å‡ºå£å æ¯”": "60%", "å¸¦åŠ¨å†œæˆ·": "5000æˆ·" } },
            { name: "æ¾æ—æ¡ƒèŠ±å±±", coords: [31.045, 104.325], group: "eco", icon: "mountain-sun", desc: "å¹¿æ±‰è‘—åèµèŠ±èƒœåœ°ï¼Œä¹¡æ‘æ—…æ¸¸åç‰‡ã€‚", stats: { "èµèŠ±æ—ºå­£": "3æœˆ", "æ—…æ¸¸æ”¶å…¥": "5000ä¸‡" } },
            { name: "å°æ±‰é•‡é«˜æ ‡å‡†å†œç”°", coords: [31.015, 104.265], group: "eco", icon: "wheat-awn", desc: "å…¨ç¨‹æœºæ¢°åŒ–è€•ä½œç¤ºèŒƒåŒºã€‚", stats: { "æœºæ¢°åŒ–ç‡": "98%", "äº©äº§é‡": "650kg" } },

            // --- äº§ä¸šä¸å‘å±•ç»„ (Orange) ---
            { name: "é«˜åªç¨»è™¾åŸºåœ°", coords: [30.99, 104.28], group: "ind", icon: "shrimp", desc: "ç¨»è™¾å…±ä½œç”Ÿæ€å…»æ®–æ¨¡å¼æ¨å¹¿åŸºåœ°ã€‚", stats: { "äº©å‡å¢æ”¶": "3000å…ƒ", "å…»æ®–è§„æ¨¡": "5000äº©" } },
            { name: "å‘é˜³æ”¹é©é™ˆåˆ—é¦†", coords: [31.055, 104.245], group: "ind", icon: "landmark", desc: "ä¸­å›½å†œæ‘æ”¹é©ç¬¬ä¸€ä¹¡å†å²è§è¯ã€‚", stats: { "å†å²æ„ä¹‰": "æ‘˜ä¸‹ç¬¬ä¸€ç‰Œ", "å¹´è®¿å®¢": "10ä¸‡" } },
            { name: "å¹¿æ±‰å·¥ä¸šé›†ä¸­å‘å±•åŒº", coords: [30.965, 104.265], group: "ind", icon: "industry", desc: "å…ˆè¿›åˆ¶é€ ä¸šä¸ç°ä»£ç‰©æµé›†èšåŒºã€‚", stats: { "å…¥é©»ä¼ä¸š": "120å®¶", "æ€»äº§å€¼": "200äº¿" } },
            { name: "ä¸­é£é™¢ (é€šèˆªæœºåœº)", coords: [30.985, 104.215], group: "ind", icon: "plane-departure", desc: "ä¸­å›½æ°‘èˆªé£è¡Œå‘˜çš„æ‘‡ç¯®ï¼Œæ— äººæœºäº§æ•™èåˆã€‚", stats: { "å¹´é£è¡Œé‡": "å…¨äºšæ´²ç¬¬ä¸€", "äººæ‰è¾“å‡º": "90%" } },
            { name: "æ–°ä¸°ç‰©æµå›­", coords: [30.960, 104.190], group: "ind", icon: "truck-fast", desc: "è¿æ¥æˆå¾·çœ‰èµ„çš„é‡è¦ç‰©æµæ¢çº½ã€‚", stats: { "æ—¥ååé‡": "5ä¸‡å¨", "è¦†ç›–èŒƒå›´": "è¥¿å—å…¨å¢ƒ" } },

            // --- æ–‡æ—…ä¸åŸå¸‚ç»„ (Pink/Blue) ---
            { name: "ä¸‰æ˜Ÿå †åšç‰©é¦†", coords: [30.993, 104.205], group: "tour", icon: "mask", desc: "æ²‰ç¡æ•°åƒå¹´ï¼Œä¸€é†’æƒŠå¤©ä¸‹ã€‚å¤èœ€æ–‡æ˜ä¹‹å…‰ã€‚", stats: { "é¦†è—æ–‡ç‰©": "1000+", "å›½é™…çŸ¥ååº¦": "Sçº§" } },
            { name: "ä¸‰æ˜Ÿå †è€ƒå¤é—å€å…¬å›­", coords: [30.998, 104.200], group: "tour", icon: "trowel", desc: "æŒç»­è¿›è¡Œçš„ç¥­ç¥€å‘è€ƒå¤å‘æ˜ç°åœºã€‚", stats: { "å‘æ˜é¢ç§¯": "12kmÂ²", "æ–°å‘ç°": "é»„é‡‘é¢å…·" } },
            { name: "æˆ¿æ¹–å…¬å›­", coords: [30.978, 104.253], group: "tour", icon: "fan", desc: "å”ä»£åç›¸æˆ¿ç¯æ‰€å»ºï¼Œå·è¥¿å›­æ—å…¸èŒƒã€‚", stats: { "å¤æ ‘åæœ¨": "12æ ª", "å¸‚æ°‘ä¼‘é—²": "é¦–é€‰åœ°" } },
            { name: "å¹¿æ±‰æ–‡åº™", coords: [30.975, 104.250], group: "tour", icon: "scroll", desc: "è§„æ¨¡å®å¤§ï¼Œä¿å­˜å®Œå¥½çš„æ¸…ä»£æ–‡åº™å»ºç­‘ç¾¤ã€‚", stats: { "å»ºç­‘ç­‰çº§": "å›½ä¿å•ä½", "æ´»åŠ¨": "ç¥­å­”å¤§å…¸" } },
            { name: "è¿å±±é•‡æ”¿åºœ", coords: [31.020, 104.300], group: "tour", icon: "flag", desc: "ç»Ÿç­¹è¿å±±ç‰‡åŒºæ–‡æ—…èµ„æºè°ƒåº¦çš„æŒ‡æŒ¥ä¸­å¿ƒã€‚", stats: { "æ•°å­—åŒ–": "å…¨è¦†ç›–", "å“åº”é€Ÿåº¦": "å¿«" } },
            { name: "å¹¿æ±‰é«˜é“ç«™", coords: [31.005, 104.290], group: "tour", icon: "train", desc: "æˆç»µä¹åŸé™…é“è·¯é‡è¦ç«™ç‚¹ã€‚", stats: { "æˆéƒ½é€šè¾¾": "18åˆ†é’Ÿ", "æ—¥å®¢æµ": "1.5ä¸‡" } },
            { name: "é”¦èŠ±ä¹æœˆ", coords: [30.955, 104.285], group: "tour", icon: "camera", desc: "æ–°å…´çš„ç½‘çº¢æ‰“å¡ä¸ä¹¡æ‘æ°‘å®¿èšé›†åœ°ã€‚", stats: { "å‘¨æœ«å…¥ä½ç‡": "95%", "å¥½è¯„ç‡": "4.9" } }
        ];

        // --- 3. å¡«å……ä¹¡é•‡å¯¼èˆªä¸‹æ‹‰æ¡† ---
        const selectBox = document.getElementById('townSelect');
        towns.forEach(town => {
            const option = document.createElement('option');
            option.value = JSON.stringify(town.coords);
            option.text = town.name;
            selectBox.appendChild(option);
        });

        // å¯¼èˆªåŠŸèƒ½å‡½æ•°
        window.flyToTown = function(coordsStr) {
            if (!coordsStr) return;
            const coords = JSON.parse(coordsStr);
            map.flyTo(coords, 14, {
                duration: 2, // åŠ¨ç”»æ—¶é•¿2ç§’
                easeLinearity: 0.25
            });
        };

        // --- 4. æ„å»ºå›¾å±‚ ---
        const layers = {
            eco: L.layerGroup(),
            ind: L.layerGroup(),
            tour: L.layerGroup()
        };

        // å›¾æ ‡ç”Ÿæˆå™¨
        const createIcon = (iconName, color) => L.divIcon({
            html: `<div style="background-color: ${color}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px ${color}; border: 2px solid #fff;">
                    <i class="fa-solid fa-${iconName}" style="color: #fff; font-size: 14px;"></i>
                   </div>`,
            className: 'custom-poi-icon',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });

        // éå†æ·»åŠ ç‚¹ä½ (POI Data)
        poiData.forEach(poi => {
            let color = '#00eaeb'; // é»˜è®¤é’è‰²
            if (poi.group === 'eco') color = '#32CD32'; // ç»¿
            if (poi.group === 'ind') color = '#FFA500'; // æ©™
            if (poi.group === 'tour') color = '#FF1493'; // ç²‰

            const marker = L.marker(poi.coords, {
                icon: createIcon(poi.icon, color)
            });

            let statsHtml = '<table class="popup-table">';
            for (const [key, value] of Object.entries(poi.stats)) {
                statsHtml += `<tr><td>${key}</td><td class="popup-data">${value}</td></tr>`;
            }
            statsHtml += '</table>';

            const popupContent = `
                <div style="min-width: 180px;">
                    <h3 style="margin:0 0 5px 0; color:${color}; border-bottom:1px solid #444; padding-bottom:5px; font-size:14px;">
                        <i class="fa-solid fa-${poi.icon}"></i> ${poi.name}
                    </h3>
                    <div style="font-size:11px; color:#ccc; line-height:1.4;">${poi.desc}</div>
                    ${statsHtml}
                </div>
            `;
            
            marker.bindPopup(popupContent);
            // ä¿®å¤ç‚¹ï¼šä½¿ç”¨ .addLayer() è€Œä¸æ˜¯ .addMarker()
            layers[poi.group].addLayer(marker);
        });

        // --- 5. ç‰¹æ®Šå›¾å±‚é€»è¾‘ (ä¿ç•™æ‰€æœ‰çƒ­åŠ›ä¸è·¯çº¿) ---
        
        // 5.1 ç”Ÿæ€è¿çº¿ (Green) - æ¹”æ±Ÿç»¿é“
        const ecoLine = L.polyline([[30.95, 104.22], [30.958, 104.235]], {
            color: '#32CD32', weight: 4, dashArray: '10, 10'
        }).bindTooltip("æ¹”æ±Ÿç”Ÿæ€ç»¿é“").addTo(layers.eco);

        // 5.2 äº§ä¸šçƒ­åŠ› (Orange) - é«˜åªé•‡åŒºåŸŸ
        const heatData = [];
        for (let i = 0; i < 80; i++) {
            const lat = 30.99 + (Math.random() - 0.5) * 0.03;
            const lon = 104.28 + (Math.random() - 0.5) * 0.03;
            heatData.push([lat, lon, Math.random()]);
        }
        const heatLayer = L.heatLayer(heatData, {
            radius: 30, blur: 20, gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
        });
        
        // 5.3 æ–‡æ—…æµçº¿ (Pink) - ä¸‰æ˜Ÿå †åˆ°è¿å±±
        const pathPoints = [[30.993, 104.205], [31.010, 104.25], [31.025, 104.305]];
        let antPolyline;

        // å®¹é”™é€»è¾‘ï¼šå¦‚æœ ant-path åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šè™šçº¿
        if (typeof L.Polyline.AntPath !== 'undefined') {
             antPolyline = new L.Polyline.AntPath(pathPoints, {
                delay: 1000, dashArray: [10, 20], weight: 4, color: "#FF1493", pulseColor: "#FFFFFF"
            });
        } else {
            console.warn("Leaflet AntPath plugin failed to load. Falling back to simple polyline.");
            antPolyline = L.polyline(pathPoints, {
                color: "#FF1493", weight: 4, dashArray: '10, 20'
            });
        }
        
        antPolyline.bindTooltip("å®¢æµå¼•å¯¼è·¯å¾„").addTo(layers.tour);


        // --- 6. æœ€ç»ˆå›¾å±‚åŠ è½½ä¸æ§ä»¶ ---
        
        // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å›¾å±‚
        layers.eco.addTo(map);
        layers.ind.addTo(map);
        layers.tour.addTo(map);
        
        // ä¿®å¤ï¼šçƒ­åŠ›å›¾ä¸ç›´æ¥åŠ å…¥ï¼Œè€Œæ˜¯é€šè¿‡å®‰å…¨æœºåˆ¶åŠ è½½
        // heatLayer.addTo(map); <--- å·²ç§»é™¤

        // å›¾å±‚æ§åˆ¶å™¨
        const overlays = {
            '<span style="color:#32CD32">ğŸƒ ç”Ÿæ€å†œä¸š (ä¸‰æ°´/é‡‘è½®)</span>': layers.eco,
            '<span style="color:#FFA500">ğŸ­ äº§ä¸šå‘å±• (é«˜åª/å‘é˜³)</span>': layers.ind,
            '<span style="color:#FF1493">ğŸ¡ æ–‡æ—…ä½“éªŒ (ä¸‰æ˜Ÿå †/è¿å±±)</span>': layers.tour,
            '<span style="color:red">ğŸ”¥ å…¨åŸŸçƒ­åŠ›å›¾</span>': heatLayer
        };

        L.control.layers(null, overlays, { collapsed: false, position: 'topright' }).addTo(map);

        // é¹°çœ¼å·¥å…·
        const miniMapLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
        new L.Control.MiniMap(miniMapLayer, { toggleDisplay: true, position: 'bottomright' }).addTo(map);
        
        // æµ‹è·å·¥å…· (å¢åŠ å®¹é”™åˆ¤æ–­)
        if (typeof L.Control.Measure !== 'undefined') {
            new L.Control.Measure({ 
                position: 'topright', 
                primaryLengthUnit: 'meters', 
                activeColor: '#00eaeb' 
            }).addTo(map);
        } else {
            console.warn("Leaflet Measure plugin failed to load. Measurement tool skipped.");
        }

        // --- 7. å…¨å±€ä¿®å¤ï¼šçƒ­åŠ›å›¾å®‰å…¨åŠ è½½æœºåˆ¶ (V2.5 é€’å½’æ£€æµ‹) ---
        
        function addHeatmapSafe() {
            const size = map.getSize();
            // æ ¸å¿ƒä¿®å¤é€»è¾‘ï¼šæ£€æµ‹åœ°å›¾å®¹å™¨å®½å’Œé«˜æ˜¯å¦éƒ½å¤§äº0
            if (size.x > 0 && size.y > 0) {
                map.invalidateSize(); // ç¡®ä¿å®¹å™¨å°ºå¯¸åŒæ­¥
                heatLayer.addTo(map); // å®‰å…¨åŠ è½½çƒ­åŠ›å›¾
                console.log("Heatmap layer loaded safely with map size:", size);
            } else {
                console.log("Waiting for valid map container size...");
                // å¦‚æœå°ºå¯¸ä»ä¸º0ï¼Œå»¶è¿Ÿ 100ms åå†æ¬¡é€’å½’æ£€æŸ¥
                setTimeout(addHeatmapSafe, 100);
            }
        }

        // å¯åŠ¨å®‰å…¨åŠ è½½æ£€æµ‹
        map.whenReady(function() {
            addHeatmapSafe();
        });

    </script>
</body>
</html>